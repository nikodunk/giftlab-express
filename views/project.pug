extends _layout 

block content
	
	<script src="https://checkout.stripe.com/checkout.js"></script>
	<script src="http://malsup.github.com/jquery.form.js"></script>

	


	//- PROJECT HEADER
	section.showcase
			.row.panel
				.col-lg-4.my-auto.padding
					h4 #{content.ProjectName}
					p.lead #{content.BusinessName}
					p.lead #{content["Project Description - Short"]}


					a.btn.btn-sm.btn-primary.orange(href=content.wishlistlink target="_blank")
						div.row
							div.row(style="margin: 0 auto")
								i.fa.fa-amazon.fa-2x.fa-fw(style="margin-top: 12px; margin-right: 5px")
								span
									h5 AMAZON WISHLIST
					

					a.btn.btn-sm.btn-primary.orange(href="#budgets")
						div.row
							div.row(style="margin: 0 auto")
								i.fa.fa-usd.fa-2x.fa-fw(style="margin-top: 12px; margin-right: 5px")
								span
									h5 DONATE MONEY
					a.btn.btn-sm.btn-primary.jumbotronbutton(href="#project")
						div.row
							div.row(style="margin: 0 auto")
								span
									h5 LEARN MORE
				.col-lg-8.text-white(style="background-image: url(' "+content.image+" '); background-position: center;  background-size: cover; min-height:200px")
				




	section.container
		div.row
			//- AMAZON
			div.row(id="items" ).center
				h3.center(style="margin-top: 40px !important") Items in Need
				br
			div.row
				each val in skus
					if val.bucket == "Item"
			


						//- AMAZON ITEM ACTIVE
						if val.status == "Active"
							div.col-lg-4(style="margin-top: 20px !important")
								div.box-project(style="background-color: white")
									div
										h5 #{val["sku_name"]} ($#{val['unit_cost']} each)
										// p(style="color:grey")= val["Bucket"]
									div
										p= val["description"]
										// p Need: #{val['quantity_need']}&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;Total Cost: #{val['total_value']}
										meter(min="0" value=val['donatedsofar'] max=val['total_need'] style="width: 100%; background-color: lightblue")
										br
										if val.donatedsofar == null
											p(style="text-align: right") Gifted: 0 | Remaining: #{val['remaining_pretty']}
										else
											p(style="text-align: right") Gifted: #{val['donatedsofar_pretty']} | Remaining: #{val['remaining_pretty']}
									div
										a.btn.btn-lg.btn-primary.col-11.titleButton.orange(href=content.wishlistlink target="_blank") 
											div.row
												div.row(style="margin: 0 auto")
													i.fa.fa-amazon.fa-1x.fa-fw(style="margin-right: 5px; margin-top: 5px")
													span AMAZON WISHLIST

			

										br
										br
										a(href="/contact").float-right Or recycle this item

						//- AMAZON ITEM COMPLETE
						else
							div.col-lg-4(style="margin-top: 20px !important")
								div.box-project(style="background-color: #f8f9fa") 
									div
										h5 #{val["sku_name"]} ($#{val['unit_cost']} each)
										// p(style="color:grey")= val["Bucket"]
									div
										p= val["description"]
										// p Need: #{val['quantity_need']}&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;Total Cost: #{val['total_value']}
										meter(min="0" value=val['donatedsofar'] max=val['total_need'] style="width: 100%; background-color: grey")
										br
										if val.donatedsofar == null
											p(style="text-align: right") Gifted: 0 | Remaining: #{val['remaining_pretty']}
										else
											p(style="text-align: right") Gifted: #{val['donatedsofar_pretty']} | Remaining: #{val['remaining_pretty']}
									div
								
			

			// STRIPE
			div.row(id="budgets" style="margin-top: 40px!important;" )
				h3.center(style="margin-top: 40px !important" ) Project Budgets
				p.lead.mb-0.center Our project teams have worked hard to give the best estimates possible, but budgets and prices of items can fluctuate. Should something change, your monetary donation will be used for another aspect of this project. 
					small Privacy Notice: Gift Lab will share your name, billing address, e-mail, the date and amount of your contribution to the project sponsoring non-profit. Your email will be retained by Gift Lab for email marketing correspondence.

				br

			div.row
				each val in skus
						if val.bucket == "Budget"

				
							//- STRIPE ITEM ACTIVE
							if val.status == "Active"
								div.col-lg-4(style="margin-top: 20px !important")
									div.box-project(style="background-color: white")
										div
											h5 #{val["sku_name"]}
											// p(style="color:grey")= val["Bucket"]
										div
											div
												p= val["description"]
												// p Total Budget: $#{val['total_value']}
												meter(min="0" value=val['donatedsofar'] max=val['total_need'] style="width: 100%; background-color: lightblue").float-right
												br
												if val.donatedsofar == null
													p(style="text-align: right") Gifted: $0 | Remaining: $#{val['remaining_pretty']}
												else
													p(style="text-align: right") Gifted: $#{val['donatedsofar_pretty']} | Remaining: $#{val['remaining_pretty']}
										div.row
											div.test
												form( id="myForm" action="/payment/charge/"+content['ProjectID']+'/'+val['sku']+'/'+content['stripe_user_id'] method="POST")
													input( type="hidden" id="stripeToken" name="stripeToken" )
													input( type="hidden" id="stripeEmail" name="stripeEmail" )
													input( type="hidden" id="stripeAmount" name="stripeAmount" )
												input.myInput( type="number" id=val['sku'] name="amountInDollars" value="20" min="0" max=val['total_need'])
											button.btn.btn-md.btn-primary.bodyButton( class="stripe" data-sku=val['sku'] class=val['sku'])
												i.fa.fa-usd.fa-1x.fa-fw(style="margin-right: 5px; margin-top: 5px")
												span DONATE
											


							//- STRIPE ITEM COMPLETE
							else
								div.col-lg-4(style="margin-top: 20px !important")
									div.box-project(style="background-color: #f8f9fa")
										div
											h5 #{val["sku_name"]}
											// p(style="color:grey")= val["Bucket"]
										div
											div
												p= val["description"]
												// p Total Budget: $#{val['total_value']}
												meter(min="0" value=val['donatedsofar'] max=val['total_need'] style="width: 100%; background-color: grey").float-right
												br
												if val.donatedsofar == null
													p(style="text-align: right") Gifted: $0 | Remaining: $#{val['remaining_pretty']}
												else
													p(style="text-align: right") Gifted: $#{val['donatedsofar_pretty']} | Remaining: $#{val['remaining_pretty']}
										div
											h5.center(style="color:grey") COMPLETE!
					


		//- PROJECT PROFILE
		div.row(id="project")
			section(style="margin-top: 40px !important")
				div.row
					div.col-md-2
						div.row.padding
							img.thumbnail(src=content.businessimage alt="Image Title" style="max-width: 100% !important").center
							br
						div.row.padding
							h4 #{content.BusinessName}
							p.lead #{content.BusinessDescription}
					


					div.col-md-8
						div.row.padding
							h3 ABOUT THIS PROJECT
							p.lead #{content["Project Description - Long"]}
					
						div.row
							div.col-4.padding
								a.btn.btn-sm.btn-primary(href=content.BusinessWebsite) VISIT OUR WEBSITE
							div.col-4.padding
								a.btn.btn-sm.btn-primary(href=content.BusinessFacebook) FACEBOOK PAGE
							div.col-4.padding
								a.btn.btn-sm.btn-primary(href=content.BusinessInstagram) INSTAGRAM PAGE

						div.row
							div.padding.center.col-md-3
								img.thumbnail(src=content.researcherimage alt="Image Title").center
								br
							div.padding.col-md-9
								h3= content["Researcher"]
								p.lead= content["Researcher profile"]
						
					
						
										
			
		


		script.
			$( document ).ready(function() {
				mixpanel.track('project_page_loaded', {project: window.location.pathname.substr(10)});
			});

			document.querySelectorAll('.stripe').forEach(function(selector) {
				console.log(selector.dataset.sku)

				$("."+selector.dataset.sku).on('click', function(e) {
					//when click record to mixpanel
					mixpanel.track('stripe clicked');

					// get amount in cents from specific form
					var amountInCents = Math.floor($("#"+selector.dataset.sku).val() * 100);

					// Get amount ready to pass to backend: set (hidden) form stripeAmount on ALL forms (for now)
					$("#stripeAmount").val(amountInCents);

					// Open Checkout with further options
					handler.open({
						name: 'Gift Lab',
						description: 'Donation to '+ selector.dataset.sku,
						amount: amountInCents,
					});
					e.preventDefault();
				});
			});

			var handler = StripeCheckout.configure({
				key: 'pk_live_nROKLmrb4dhqpT1oWlRdS73J',
				image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
				token: function(token) {
					$("#stripeToken").val(token.id);
					$("#stripeEmail").val(token.email);
					mixpanel.track('stripe completed');
					$("#myForm").submit();
					//- $('#myForm')
					//-     .ajaxForm(function (response) {
					//-             console.log("The server says: " + response);
					//-         })
					//- ;
				}
			});

			// Close Checkout on page navigation
			$(window).on('popstate', function() {
				handler.close();
			});
						


			


			

				
